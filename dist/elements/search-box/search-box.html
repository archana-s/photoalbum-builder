<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/iron-icons/maps-icons.html">

<dom-module id="search-box">
  <style>
    :host {
      position: relative;
    }

    paper-input, paper-menu {
      width: 300px;
    }

    paper-icon-button {
      border-radius: 100%;
    }

    .search-box {
      align-items: center;
    }

    paper-menu {
      border: 1px solid #ccc;
      position: absolute;
      top: -4px;
      left: 0;
      z-index: 1000;
    }

    paper-item {
      padding: 8px 12px;
    }

    iron-icon {
      margin-right: 12px;
      width: 18px;
      height: 18px;
      color: #AAA;
    }

    .icon {
      min-width: 30px;
    }

  </style>

  <template>
    <iron-request id="mapsApiRequest"></iron-request>

    <iron-ajax
      id="ajaxRequest"
      url="https://maps.googleapis.com/maps/api/geocode/json?"
      handle-as="json"
      debounce-duration="300"
      on-response="_handleResponse"
      on-error="_handleError"
      last-response="{{mapsResult}}"></iron-ajax>

    <section class="layout horizontal" class="search-box">
      <paper-input auto-validate label="Search by tags or location" on-keydown="_inputKeyDown" on-input="_updateList"
        id="searchInput" validator="_searchValidator" error_message="Invalid search entry"></paper-input>
      <paper-icon-button raised on-click="_searchForKeywords" icon="icons:search" class="passive"></paper-icon-button>
    </section>

    <template is="dom-if" if="{{locations.length}}">
      <paper-menu id="locationMenu" on-iron-select="_itemChosen">
        <paper-item class="layout horizontal">
          <div class="icon"><iron-icon icon="icons:search"></iron-icon></div>
          <div>{{keywords}}</div>
        </paper-item>
        <template is="dom-repeat" items="{{locations}}" as="location">
          <paper-item class="layout horizontal">
            <div class="icon"><iron-icon icon="maps:place"></iron-icon></div>
            <div>{{location.formatted_address}}</div>
          </paper-item>
        </template>
      </paper-menu>
    </template>

  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'search-box',

      properties: {
        locations: {
          type: Array,
          notify: true
        },
        mapsResult: {
          type: Object,
          observer: '_mapsResultChanged'
        },
        keywords: {
          type: String
        }
      },

      _searchForKeywords: function() {
        var keywords = encodeURIComponent(this.$.searchInput.value);
        window.location.href = `/#!/search/${keywords}`;
        // Polymer does not offer any anchor-tags due to anchor tag in shadow root problems,
        // hence using a button with an action.
        // the routes are automatically not reloaded in this starter kit, as a result, manually triggering it.
        window.location.reload();
      },

      _searchForLatLong: function(idx) {
        var selectedLocation = this.locations[idx];
        var latLng = `${selectedLocation.geometry.location.lat}~${selectedLocation.geometry.location.lng}`;
        window.location.href = `/#!/search/location/${latLng}`;
        // Polymer does not offer any anchor-tags due to anchor tag in shadow root problems,
        // hence using a button with an action.
        // the routes are automatically not reloaded in this starter kit, as a result, manually triggering it.
        window.location.reload();
      },

      _inputKeyDown: function(evt) {
        var DOWN = 40;
        var ENTER = 13;
        if(evt.keyCode === ENTER) {
          // Search for the keywords
          this._searchForKeywords();
        } else if (evt.keyCode === DOWN) {
          // Allow them to browse through the list in locationMenu.
          if (this.locations.length) {
            this.querySelector('#locationMenu').focus();
          }
        }
      },

      _updateList: function() {
        this.keywords = this.$.searchInput.value;
        if (this.keywords.length === 0) {
          this.set('locations', []);
        } else {
          var params = {
            address: encodeURIComponent(this.keywords),
            key: 'AIzaSyDgAkhTXjPX0JuZyvsNska5YJPcIL48zMc'
          };
          this.$.ajaxRequest.params = params;
          this.$.ajaxRequest.generateRequest();
        }
      },

      _mapsResultChanged: function() {
        this.set('locations', this.mapsResult.results);
      },

      _itemChosen: function() {
        var selectedItemIdx = this.querySelector('#locationMenu').selected;
        if (selectedItemIdx === 0) {
          this._searchForKeywords();
        } else {
          this._searchForLatLong(selectedItemIdx - 1); //This maps directly to an index in locations array
        }
      },

      _handleError: function() {
      },

      _handleResponse: function() {
      }

    });
  })();
  </script>
</dom-module>

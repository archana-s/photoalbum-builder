<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">

<link rel="import"
  href="../../bower_components/firebase-element/firebase-collection.html">

<dom-module id="ha-user-edit-page">
  <style>
    form {
      min-width: 350px;
      margin: 18px 12px;
    }

    paper-input[disabled] {
      color: #444;
    }

    paper-icon-button {
      width: 13px;
      height: 13px;
    }

    paper-icon-button.remove {
      color: #E82C0C;
    }

    paper-button.add {
      margin: 0;
      padding: 0;
      color: #0B437F;
    }

    table {
      margin: 20px 12px;
    }

    th {
      background-color: #fafafa;
      text-align: left;
    }

    th, td {
      padding: 8px;
    }

    td {
      border-bottom: 1px dotted #ccc;
      background-color: #FDFDFD;
    }

    .auto-save {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(176, 255, 190, 0.5);
      padding: 12px 16px;
      z-index: 100;
    }

    paper-button.active, paper-button.danger {
      margin-top: 20px;
    }

    paper-button .iron-icon-0 {
      width: 16px;
      height: 16px;
    }

    paper-button.danger {
      background-color: #99312F;
      color: white;
      width: 150px;
    }

  </style>
  <template>
    <!-- fetches the user based on id. Still returns an array -->
    <firebase-collection order-by-child="id" equal-to="{{userid}}" id="userHandle"
      location="https://test-crud-app.firebaseio.com/user_info"
      data="{{users}}"></firebase-collection>

    <!-- Fetches the current user handle to update the API tokens. Firebasekey is the unique key for every user in
        addition to id. Its easier to fetch data with firebasekey-->
    <firebase-collection id="currUserHandle"
      location="https://test-crud-app.firebaseio.com/user_info/{{firebaseKey}}"
      data="{{currUser}}"></firebase-collection>

    <ha-header></ha-header>
    <div class="auto-save" hidden id="autoSave">Auto-saved</div>

    <template is="dom-if" if="{{users.length}}">
      <paper-card>
        <form class="layout vertical">
          <template is="dom-repeat" items="{{users}}" as="user">
            <paper-input label="Id" value={{user.id}} disabled></paper-input>
            <paper-input label="Email" value={{user.email}} class="email" on-change="_update"></paper-input>
            <paper-input label="Created At" value={{user.created_at}} disabled></paper-input>
            <paper-input label="Update At" value={{user.updated_at}} class="updated_at" disabled></paper-input>
          </template>
        </form>

        <table>
          <tr>
            <th> List of API tokens </th>
            <th>
              <paper-button on-click="_addToken" class="add">
                <iron-icon icon="icons:add"></iron-icon>
                Add token
              </paper-icon-button>
            </th>
          </tr>
          <!-- Lists the tokens -->
          <template is="dom-repeat" items={{apiTokens}} as="token">
            <tr>
              <td>{{token}}</td>
              <td>
                <paper-icon-button icon="icons:remove" on-click="_removeToken" class="remove"
                  id={{token}}></paper-icon-button>
              </td>
            </tr>
          </template>
        </table>
      </paper-card>

      <div class="layout horizontal center-center">
        <paper-button raised class="active layout horizontal center-center" on-click="_gotoUserList">
          Go To User List
        </paper-button>
        <paper-button raised class="danger layout horizontal center-center" on-click="_deleteUser">
          Delete User
        </paper-button>
      </div>
    </template>

    <template is="dom-if" if="{{!users.length}}">
      <p>Sorry, could not find the user you are looking for.</p>
    </template>
  </template>

  <script>
    Polymer({
      is: 'ha-user-edit-page',
      properties: {
        userid: String,
        users: {
          type: Array,
          notify: true
        },
        apiTokens: Array,
        firebaseKey: String,
        currUser: Array
      },

      ready: function() {
        this.addEventListener('users-changed', this.usersChanged);
      },

      // Fetches the firebase key upon initial load of user data.
      // this is critical to get a handle to firebase for the user for api_tokens.
      fetchFirebaseKey: function() {
        if (!this.firebaseKey) {
          this.firebaseKey = this.users[0].__firebaseKey__;
        }
      },

      // Adds a new API token to the list of tokens for user.
      _addToken: function() {
        if (!this.apiTokens.length) {
          this.apiTokens = [randomID(20, 'aA0')];
          this.$.currUserHandle.query.update({api_tokens: this.apiTokens});
        } else {
          this.apiTokens.push(randomID(20, 'aA0'));
          this.$.currUserHandle.query.update({api_tokens: this.apiTokens});
        }
        this._update();
      },

      // Deletes a token from the list.
      _removeToken: function(e) {
        var deleteToken = e.currentTarget.getAttribute('id');
        var idx = this.apiTokens.indexOf(deleteToken);
        this.apiTokens.splice(idx, 1);
        this.$.currUserHandle.query.update({api_tokens: this.apiTokens});
        this._update();
      },

      _gotoUserList: function() {
        // Use of #! here prevents auto-reload, hence reloading manually.
        window.location.href = window.location.origin + '/#!/admin';
        window.location.reload();
      },

      // Updates the updated_at for the user. also displays a nice autosaved message upon saving.
      _update: function() {
        this.updateDate();
        this.showAutosaveMessage();
      },

      // Deletes the user.
      _deleteUser: function() {
        var result = window.confirm('Are you sure you want to delete user ' + this.users[0].email);
        if (result) {
          this.$.userHandle.remove(this.users[0]);
          this._gotoUserList();
        }
      },

      // Listener for users object. Unfortunately "observer" pattern offered by Polymer isn't working as
      // expected. This method populates the initial set of apitokens. Also fetches the firebase key now
      // that the user information is available.
      usersChanged: function() {
        if (this.users.length) {
          this.apiTokens = this.users[0].api_tokens || [];
          this.fetchFirebaseKey();
        }
      },

      updateDate: function() {
        this.$.currUserHandle.query.update({updated_at: Date()});
      },

      showAutosaveMessage: function() {
        this.$.autoSave.hidden = false;
        setTimeout(function() {
          this.$.autoSave.hidden = true;
        }.bind(this), 1500);
      }

    });
  </script>
</dom-module>

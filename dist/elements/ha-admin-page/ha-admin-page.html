<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../bower_components/neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../../bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import"
  href="../../bower_components/firebase-element/firebase-collection.html">

<!-- Validation for email and password -->
<link rel="import" href="../utils/custom-validator.html">

<dom-module id="ha-admin-page">
  <style>
    :host paper-button {
      width: 200px;
    }

    .page-actions {
      margin: 20px 0;
    }

    table {
      border-bottom: 1px solid #ddd;
    }

    td, th {
      margin: 0;
      padding: 8px;
      border-left: 1px solid #ddd;
      border-top: 1px solid #ddd;
    }

    td:last-child {
      border-right: 1px solid #ddd;
    }

    tr:first-child {
      pointer-events: none;
    }

    th {
      background-color: rgba(203, 219, 156, 0.1);
      font-weight: bold;
      text-align: center;
    }

    tr:hover {
      background-color: rgba(242, 191, 179, 0.1);
    }

    paper-icon-button {
      color: #555;
    }

  </style>
  <template>

    <!-- Firebase is a nosql database. Firebase collection helps fetch the list of users -->
    <firebase-collection id="user_info"
      location="https://test-crud-app.firebaseio.com/user_info/" data="{{users}}">
    </firebase-collection>

    <template is="dom-if" if="{{!users.length}}">
      There are no user records.
    </template>

    <template is="dom-if" if="{{users.length}}">
      <ha-header></ha-header>
      <div class="layout horizontal end-justified page-actions">
        <paper-button raised class="active layout horizontal center-center" on-click="_goHome">
          <iron-icon icon="icons:home"></iron-icon>
          Go Home
        </paper-button>
      </div>

      <table>
        <tr>
          <th>Id</th>
          <th>Email Id</th>
          <th>Number of Tokens</th>
          <th>Created Date</th>
          <th>Udpated Date</th>
          <th></th>
        </tr>
        <!-- Iterates through the list of users and renders them. {{users}} here offers two-way data-binding -->
        <template is="dom-repeat" items="{{users}}" as="user">
          <tr id={{user.id}}>
            <td>{{user.id}}</td>
            <td>{{user.email}}</td>
            <td>{{user.api_tokens.length}}</td>
            <td>{{user.created_at}}</td>
            <td>{{user.updated_at}}</td>
            <td class="layout horizontal">
              <paper-icon-button on-click="_editUser" icon="editor:mode-edit" id={{user.id}}>
              </paper-icon-button>
              <paper-icon-button on-click="_deleteUser" icon="icons:delete" id={{user.id}}>
              </paper-icon-button>
            </td>
          </tr>
        </template>
      </table>

    </template>

  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'ha-admin-page',

      properties: {
        users: {
          type: Array
        }
      },

      _deleteUser: function(e) {
        var userId = e.currentTarget.getAttribute('id');
        var userIdArray = this.users.map(function(user) {
          return user.id;
        });

        var userIndex = userIdArray.indexOf(userId);
        var user = this.users[userIndex];

        var result = window.confirm('Are you sure you want to delete user ' + user.email);
        if (result) {
          this.$.user_info.remove(this.users[userIndex]);
        }
      },

      _editUser: function(e) {
        var userId = e.currentTarget.getAttribute('id');
        if (userId) {
          window.location.href = window.location.href + '/' + userId;
          // the routes are automatically not reloaded in this starter kit due to use of #!,
          // as a result, manually triggering it.
          window.location.reload();
        }
      },

      _goHome: function() {
        window.location.href = window.location.origin;
      }
    });
  })();
  </script>
</dom-module>

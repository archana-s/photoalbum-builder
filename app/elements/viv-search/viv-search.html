<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../searched-photos/searched-photos.html">
<link rel="import" href="../../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-request.html">
<link rel="import" href="../search-box/search-box.html">
<link rel="import" href="../locations-list/locations-list.html">

<dom-module id="viv-search">
  <style>

    :host {
      background-color: #DDD;
    }

    paper-input {
      width: 300px;
    }

    paper-button.load-more {
      width: 180px;
      margin: 20px 0  ;
    }

    search-box {
      flex: 1;
      align-self: flex-start;
    }

    .tool-box {
      align-items: center;
    }

    locations-list {
      margin-top: 20px;
    }
  </style>

  <template>

    <iron-localstorage name="album"
      value="{{album}}" id="localStorage"
    ></iron-localstorage>

    <iron-ajax
      id="ajaxRequest"
      url="https://api.flickr.com/services/rest/"
      handle-as="json"
      debounce-duration="300"
      on-response="_handleResponse"
      on-error="_handleError"
      last-response="{{response}}"></iron-ajax>

    <iron-request id="mapsApiRequest"></iron-request>

    <section class="tool-box layout horizontal wrap">
      <div class="flex-1">
        <search-box></search-box>
      </div>
      <template is="dom-if" if="{{album.photos}}">
        <paper-button raised on-click="_goToAlbum" class="passive">
          <iron-icon icon="image:camera"></iron-icon>
          {{album.name}}
        </paper-button>
      </template>
    </section>

    <template is="dom-if" if="{{locations.length}}">
      <locations-list locations={{locations}} class="layout horizontal center-center"></locations-list>
    </template>

    <template is="dom-if" if="{{keywords}}">
        <template is="dom-if" if="{{photos.length}}">
          <section class="presentation-area">
            <paper-button raised on-click="_addPhotosToAlbum" class="primary external-action-button">
              <iron-icon icon="icons:add" class="small"></iron-icon>
              Add Photos to Album
            </paper-button>

            <searched-photos id="searchedPhotos" photos="{{photos}}"></searched-photos>

            <template is="dom-if" if="{{areThereMorePagesToLoad}}">
              <div class="layout horizontal center-center">
                <paper-button raised on-click="_loadMorePhotos" class="load-more passive">Load more ...</paper-button>
              </div>
            </template>
         </section>
        </template>

        <template is="dom-if" if="{{!photos.length}}">
          <template is="dom-if" if="{{!locations.length}}">
            <section class="empty-state  horizontal layout center-center">
              <iron-icon icon="icons:info" class="small"></iron-icon>
              Sorry, no images were found for the search. Please try something else.
            </section>
          </template>
        </template>

    </template>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'viv-search',

      properties: {
        keywords: {
          type: String,
          value: '',
          observer: '_keywordsChanged'
        },
        photos: {
          type: Array,
          observer: '_photosChanged',
          value: [],
          notify: true
        },
        album: {
          type: Object,
          value: {}
        },
        currentPage: {
          type: Number,
          value: 1
        },
        maxPages: {
          type: Number,
          value: 0
        },
        response: {
          type: Object,
          value: null,
          observer: "_responseChanged"
        },
        areThereMorePagesToLoad: false,
        locations: {
          type: Array,
          value: [],
          notify: true
        }
      },

      ready: function() {
        this.setUpEventListeners();
      },

      setUpEventListeners: function() {
        this.addEventListener('location:chosen', function(data) {
          var result = data.detail;
          this.getPhotosFromFlickr(result.lat, result.lng);
          this.set('locations', []);
        });
        this.addEventListener('location:cancelled', function() {
          this.getPhotosFromFlickr();
          this.set('locations', []);
        });
      },

      // If the keywords provided is a valid address/geographic location
      // pick up images from the corresponding lat and long.
      // If not fetch images for the keywords.
      getPhotosFromFlickr: function(lat, lng) {
        if (this.keywords) {
          var keywords = decodeURIComponent(this.keywords);
          var params = {
            method: 'flickr.photos.search',
            api_key: 'ee53119fe0a002007ec0295663ef5286',
            format: 'json',
            nojsoncallback: 1,
            page: this.currentPage
          };
          if (lat && lng) {
            params.lat = lat;
            params.lon = lng;
          } else {
            params.tags = keywords;
          }
          this.$.ajaxRequest.params = params;
          this.$.ajaxRequest.generateRequest();
        }
      },

      // Invokes a google maps api call to check if the entered keywords
      // correspond to a location.
      // If they do, the result data will not be empty.
      // This returns a promise from iron-request.
      getLatLongFromMaps: function() {
        if (this.keywords) {
          // iron-request is not doing anything with params object, even though it should be.
          // hence manually building the query string. Todo(send a PR to iron-request.html)
          var requestObj = {
            url: 'https://maps.googleapis.com/maps/api/geocode/json?key=AIzaSyDgAkhTXjPX0JuZyvsNska5YJPcIL48zMc&address="' + encodeURIComponent(this.keywords) + '"',
          }
          return this.$.mapsApiRequest.send(requestObj);
        } else {
          return null;
        }
      },

      resetCounters: function() {
        this.currentPage = 1;
        this.maxPages = 0;
      },

      _keywordsChanged: function() {
        this.resetCounters();
        // Try to check if the keywors typed is actually a location.
        var mapsApiResponse = this.getLatLongFromMaps();
        if (mapsApiResponse) {
          mapsApiResponse.then(function(response) {
            var mapsResult = JSON.parse(response.response);
            if(mapsResult.results.length) {
              this.set('locations', mapsResult.results);
              // Check if they meant any of these places.
              // If so, pull it using lat long, if not just pull using tagnames.
            } else {
              this.getPhotosFromFlickr();
            }
          }.bind(this), function(err) {
            this.getPhotosFromFlickr();
          }.bind(this));
        }
      },

      _handleResponse: function(e) {
      },

      _handleError: function(err) {
      },

      _photosChanged: function() {
      },

      _responseChanged: function() {
        if (this.response && this.response.photos && typeof this.response.photos === 'object') {
          this.maxPages = this.response.photos.pages;
          this.areThereMorePagesToLoad = this.currentPage < this.maxPages;
          this.set('photos', this.photos.concat(this.response.photos.photo));
        }
      },

      goToAlbum: function() {
        window.location.href = '/#!/album';
        // Polymer does not offer any anchor-tags due to anchor tag in shadow root problems,
        // hence using a button with an action.
        // the routes are automatically not reloaded in this starter kit, as a result, manually triggering it.
        window.location.reload();
      },

      _addPhotosToAlbum: function() {
        var album = this.album;

        if (!this.album) {
          album = {
            name: 'My album',
            photos: []
          }
        }

        if (this.album && !this.album.photos) {
          album.photos = [];
        }

        album.photos = album.photos.concat(this.querySelector('#searchedPhotos').selectedPhotos);

        this.set('album', album);
        this.$.localStorage.save();
        this.goToAlbum();
      },

      _loadMorePhotos: function() {
        this.currentPage++;
        this.getPhotosFromFlickr();
      },

      _goToAlbum: function() {
        if (this.querySelector('#searchedPhotos').selectedPhotos.length) {
          var warning = `You have some images selected. If you move without adding them,
            they will not be added to your album. Are you sure you want to move to album?`;
          if (window.confirm(warning)) {
            this.goToAlbum();
          }
        } else {
          this.goToAlbum();
        }
      }

    });
  })();
  </script>
</dom-module>

<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../searched-photos/searched-photos.html">
<link rel="import" href="../../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../search-box/search-box.html">

<dom-module id="viv-album">
  <style>
    .title-section {
      flex: 1;
    }
    .add-button {
      height: 36px;
    }

    .add-button iron-icon {
      width: 14px;
      height: 14px;
    }
  </style>
  <template>
    <iron-localstorage name="album" id="localStorage"
      value="{{album}}"
    ></iron-localstorage>

    <header class="layout horizontal">
      <section class="title-section">
        <h1>
          <div contenteditable="true" on-blur="_nameChanged" id="albumName">{{album.name}}</div>
          <template is="dom-if" if="{{album.photos.length}}">
             <span class="auxiliary">{{album.photos.length}} photos</span>
          </template>
        </h1>
      </section>
      <paper-button raised class="passive add-button" on-click="_goToSearchPage">
        <iron-icon icon="icons:add"></iron-icon>
        Add photos
      </paper-button>
    </header>

    <template is="dom-if" if="{{album.photos.length}}">
      <section class="presentation-area">
        <paper-button raised on-click="_deletePhotos" class="external-action-button">
          <iron-icon icon="icons:delete" class="small"></iron-icon>
          Delete Selected Photos
        </paper-button>
        <searched-photos id="photosList" photos="{{album.photos}}"></searched-photos>
      </section>
    </template>

    <template is="dom-if" if="{{!album.photos.length}}">
      <section class="empty-state layout horizontal center-center">
        <iron-icon icon="icons:info"></iron-icon>
        You have no photos in your album. Use the search box above to search for photos and add them.
      </section>
    </template>

  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'viv-album',
      properties: {
        album: {
          type: Object,
          notify: true
        }
      },

      _deletePhotos: function() {
        var photosSelectedForDeletion = this.querySelector('#photosList').selectedPhotos;
        var photoIdsSelectedForDeletion = photosSelectedForDeletion.map(function(photo) {
          return photo.id;
        });

        var photos = JSON.parse(JSON.stringify(this.album.photos));

        for(var i=photos.length-1; i >= 0; i--) {
          if (photoIdsSelectedForDeletion.indexOf(photos[i].id) >= 0) {
            photos.splice(i, 1);
          }
        }

        var album = {
          name: this.album.name,
          photos: photos
        };

        this.set('album', album);
        this.$.localStorage.save();
      },

      _nameChanged: function() {
        this.album.name = this.querySelector('#albumName').textContent;
        this.set('album', this.album);
        this.$.localStorage.save();
      },

      _goToSearchPage: function() {
        window.location.href = '/#!/search';
        // Polymer does not offer any anchor-tags due to anchor tag in shadow root problems,
        // hence using a button with an action.
        // the routes are automatically not reloaded in this starter kit, as a result, manually triggering it.
        window.location.reload();
      }

    });
  })();
  </script>
</dom-module>
